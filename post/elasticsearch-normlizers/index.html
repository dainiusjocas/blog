<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academic 4.5.0"><meta name=author content="Dainius Jocas"><meta name=description content="In this article I'll explain what the normalizer is and show it's use case for **normalizing** URLs."><link rel=alternate hreflang=en-us href=https://www.jocas.lt/blog/post/elasticsearch-normlizers/><meta name=theme-color content="#2962ff"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css crossorigin=anonymous title=hl-dark disabled><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin=anonymous><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap"><link rel=stylesheet href=/blog/css/academic.css><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','UA-122337142-2');</script><link rel=manifest href=/blog/index.webmanifest><link rel=icon type=image/png href=/blog/img/icon-32.png><link rel=apple-touch-icon type=image/png href=/blog/img/icon-192.png><link rel=canonical href=https://www.jocas.lt/blog/post/elasticsearch-normlizers/><meta property="twitter:card" content="summary_large_image"><meta property="og:site_name" content="Dainius Jocas"><meta property="og:url" content="https://www.jocas.lt/blog/post/elasticsearch-normlizers/"><meta property="og:title" content="A Neat Trick with Elasticsearch Normalizers | Dainius Jocas"><meta property="og:description" content="In this article I'll explain what the normalizer is and show it's use case for **normalizing** URLs."><meta property="og:image" content="https://www.jocas.lt/blog/post/elasticsearch-normlizers/featured.jpg"><meta property="twitter:image" content="https://www.jocas.lt/blog/post/elasticsearch-normlizers/featured.jpg"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2020-07-08T00:00:00+00:00"><meta property="article:modified_time" content="2020-07-08T00:00:00+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.jocas.lt/blog/post/elasticsearch-normlizers/"},"headline":"A Neat Trick with Elasticsearch Normalizers","image":["https://www.jocas.lt/blog/post/elasticsearch-normlizers/featured.jpg"],"datePublished":"2020-07-08T00:00:00Z","dateModified":"2020-07-08T00:00:00Z","author":{"@type":"Person","name":"Dainius Jocas"},"publisher":{"@type":"Organization","name":"Dainius Jocas","logo":{"@type":"ImageObject","url":"https://www.jocas.lt/blog/img/icon-512.png"}},"description":"In this article I'll explain what the normalizer is and show it's use case for **normalizing** URLs."}</script><title>A Neat Trick with Elasticsearch Normalizers | Dainius Jocas</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><nav class="navbar navbar-light fixed-top navbar-expand-lg py-0 compensate-for-scrollbar" id=navbar-main><div class=container><a class=navbar-brand href=/blog/>Dainius Jocas</a>
<button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar aria-controls=navbar aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="collapse navbar-collapse" id=navbar><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/blog/#posts><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/blog/#projects><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/blog/#talks><span>Talks</span></a></li><li class=nav-item><a class="nav-link js-search" href=#><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link js-dark-toggle" href=#><i class="fas fa-moon" aria-hidden=true></i></a></li></ul></div></div></nav><article class=article><div class="article-container pt-3"><h1>A Neat Trick with Elasticsearch Normalizers</h1><div class=article-metadata><div><span><a href=/blog/authors/dainius-jocas/>Dainius Jocas</a></span></div><span class=article-date>Jul 8, 2020</span>
<span class=middot-divider></span><span class=article-reading-time>6 min read</span>
<span class=middot-divider></span><span class=article-categories><i class="fas fa-folder mr-1"></i><a href=/blog/categories/elasticsearch/>Elasticsearch</a></span></div><div class="btn-links mb-3"></div></div><div class="article-header article-container featured-image-wrapper mt-4 mb-4" style=max-width:720px;max-height:432px><div style=position:relative><img src=/blog/post/elasticsearch-normlizers/featured_hu7f89747a92563e4ac638cb49ff464efa_39418_720x0_resize_q90_lanczos.jpg alt class=featured-image>
<span class=article-header-caption><a href=https://mp4gain.com/mp4gain/wp-content/uploads/2019/12/normalize-audio-1.jpg>Photo by ze intenets</a></span></div></div><div class=article-container><div class=article-style><p>To analyze the textual data Elasticsearch uses <strong>analyzers</strong> while for the keyword analysis there is a thing called a <strong>normalizer</strong>. In this article I&rsquo;ll explain what the normalizer is and show it&rsquo;s use case for <strong>normalizing</strong> URLs.</p><h2 id=tldr>TL;DR</h2><p>A neat use case for keyword normalizers is to extract a specific part of the URL with a char_filter of the <code>pattern_replace</code> type.</p><h2 id=introduction>Introduction</h2><p>In Elasticsearch the textual data is represented with two data types: <code>text</code> and <code>keyword</code>. The <code>text</code> type is meant to be used for full-text search use cases while <code>keyword</code> is mean for filtering, sorting, and aggregation.</p><h3 id=tldr-about-analyzers>TL;DR About Analyzers</h3><p>To make a better use of <code>text</code> data you can setup the <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/analyzer-anatomy.html>analyzer</a> which is a combination of three components:</p><ul><li>exactly one <strong>tokenizer</strong>,</li><li>zero or more <strong>character filters</strong>,</li><li>zero or more <strong>token filters</strong>.</li></ul><p>Basically, an analyzer transforms a single <em>string</em> into <em>words</em>, e.g. <code>"This is my text"</code> can be transformed into <code>["this", "my", "text"]</code> which you can read as:</p><ul><li>text is split into tokens by tokenizer,</li><li>each token is lowercased with the a token filter,</li><li>stopwords are removed with another token filter.</li></ul><h3 id=normalizers>Normalizers</h3><p>The <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-normalizers.html>documentation</a> says that:</p><blockquote><p>Normalizers are similar to analyzers except that they may only emit a single token.</p></blockquote><p>Normalizers can only be applied to the <code>keyword</code> datatype. The cannonical use case is to lowercase structured content such as IDs, email addresses, e.g. a database stores emails in whatever case but searching for emails should be case insensitive. Note that only a subset of available filters can be used by a normalizer: all filters must work on a <strong>per-character basis</strong>, i.e. no stopwords or stemmers.</p><h3 id=normalizers-for-normalizing-url-data>Normalizers for Normalizing URL Data</h3><p>Storing a URL in a <code>keyword</code> field allows to filter, sort, and aggregate your data per URL. But what if you need to filter, sort, and aggregate by just one part of the URL and you have little to no control over the upstream data source? You have a couple of options:</p><ul><li>convince upstream to extract that one part in their code and send it to you,</li><li>setup a <code>text</code> field with an analyzer that produces just that one token and enable field data (not a default setup and can get expensive).</li><li>setup a <code>keyword</code> field with a normalizer with a <code>char_filter</code>.</li><li>give up.</li></ul><p>I want to explore the <code>keyword</code> option. In the next section I&rsquo;ll show how to setup normalizers for Elasticsearch URLs.</p><h3 id=the-not-so-synthetic-problem>The not so Synthetic Problem</h3><p>We have a list URLs without a hostname that were used to query Elasticsearch, e.g.: <code>/my_search_index/_search?q=elasticsearch</code> and we need to split URLs into parts such as: index, operation endpoint, e.g.: <code>_search</code> or <code>_count</code>, query filters, etc. In the following example I&rsquo;ll focus on the extracting the index part of the URL.</p><p>Let&rsquo;s create an index:</p><pre><code>PUT elasticsearch_url_index
{
  &quot;settings&quot;: {
    &quot;index&quot;: {
      &quot;analysis&quot;: {
        &quot;normalizer&quot;: {
          &quot;index_extractor_normalizer&quot;: {
            &quot;type&quot;: &quot;custom&quot;,
            &quot;char_filter&quot;: [
              &quot;index_name_extractor&quot;
            ]
          }
        },
        &quot;char_filter&quot;: {
          &quot;index_name_extractor&quot;: {
            &quot;type&quot;: &quot;pattern_replace&quot;,
            &quot;pattern&quot;: &quot;/(.+)/.*&quot;,
            &quot;replacement&quot;: &quot;$1&quot;
          }
        }
      }
    }
  },
  &quot;mappings&quot; : {
    &quot;properties&quot;: {
      &quot;url&quot;: {
        &quot;type&quot;: &quot;keyword&quot;,
        &quot;fields&quot;: {
          &quot;index&quot;: {
            &quot;type&quot;: &quot;keyword&quot;,
            &quot;normalizer&quot;: &quot;index_extractor_normalizer&quot;   
          }
        }
      }
    }
  }
}
</code></pre><p>Here we setup the index with a normalizer <code>index_extractor_normalizer</code> that has a char filter <code>index_name_extractor</code> that uses a regex <code>pattern_replace</code> to extract characters between the first and the second slashes. The mappings have a property <code>url</code> which is of the <code>keyword</code> type and have a field <code>index</code> which is also of the <code>keyword</code> type and is set up to use the normalizer <code>index_extractor_normalizer</code>.</p><p>Since the normalizer is basically a collection of filters we can use our good old friend <code>_analyze</code> API to test how it works.</p><pre><code>POST elasticsearch_url_index/_analyze
{
  &quot;char_filter&quot;: [&quot;index_name_extractor&quot;],
  &quot;text&quot;: [&quot;/my_search_index/_search?q=elasticsearch&quot;]
}
</code></pre><p>Produces:</p><pre><code>{
  &quot;tokens&quot; : [
    {
      &quot;token&quot; : &quot;my_search_index&quot;,
      &quot;start_offset&quot; : 0,
      &quot;end_offset&quot; : 40,
      &quot;type&quot; : &quot;word&quot;,
      &quot;position&quot; : 0
    }
  ]
}
</code></pre><p>Good, exactly as we wanted: <code>/my_search_index/_search?q=elasticsearch</code> => <code>my_search_index</code>.</p><p>Let&rsquo;s index some data:</p><pre><code>PUT elasticsearch_url_index/_doc/0
{
  &quot;url&quot;: &quot;/my_search_index/_search?q=elasticsearch&quot;
}
</code></pre><p>Let&rsquo;s try to filter URLs by the index name:</p><pre><code>GET elasticsearch_url_index/_search?q=url:my_search_index
</code></pre><p>Produces:</p><pre><code>{
  &quot;took&quot; : 0,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : {
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  },
  &quot;hits&quot; : {
    &quot;total&quot; : {
      &quot;value&quot; : 0,
      &quot;relation&quot; : &quot;eq&quot;
    },
    &quot;max_score&quot; : null,
    &quot;hits&quot; : [ ]
  }
}
</code></pre><p>No results? What? Oh! Wrong field: <code>url</code> was used instead of <code>url.index</code>. Let&rsquo;s try once again:</p><pre><code>GET elasticsearch_url_index/_search?q=url.index:my_search_index
</code></pre><p>Produces:</p><pre><code>{
  &quot;took&quot; : 1,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : {
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  },
  &quot;hits&quot; : {
    &quot;total&quot; : {
      &quot;value&quot; : 1,
      &quot;relation&quot; : &quot;eq&quot;
    },
    &quot;max_score&quot; : 0.2876821,
    &quot;hits&quot; : [
      {
        &quot;_index&quot; : &quot;elasticsearch_url_index&quot;,
        &quot;_type&quot; : &quot;_doc&quot;,
        &quot;_id&quot; : &quot;0&quot;,
        &quot;_score&quot; : 0.2876821,
        &quot;_source&quot; : {
          &quot;url&quot; : &quot;/my_search_index/_search?q=elasticsearch&quot;
        }
      }
    ]
  }
}
</code></pre><p>As expected. Cool.</p><h3 id=bonus-a-trick-with-the-docvalue_fields>Bonus: a Trick with the <code>docvalue_fields</code></h3><p>Another neat trick is that we can get out the <code>index</code> part of the URL from an Elasticsearch index using the <code>docvalue_fields</code> option in a request ,e.g.:</p><pre><code>GET elasticsearch_url_index/_search?q=url.index:my_search_index
{
  &quot;docvalue_fields&quot;: [&quot;url.index&quot;]
}
</code></pre><p>Produces:</p><pre><code>{
  &quot;took&quot; : 1,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : {
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  },
  &quot;hits&quot; : {
    &quot;total&quot; : {
      &quot;value&quot; : 1,
      &quot;relation&quot; : &quot;eq&quot;
    },
    &quot;max_score&quot; : 0.2876821,
    &quot;hits&quot; : [
      {
        &quot;_index&quot; : &quot;elasticsearch_url_index&quot;,
        &quot;_type&quot; : &quot;_doc&quot;,
        &quot;_id&quot; : &quot;0&quot;,
        &quot;_score&quot; : 0.2876821,
        &quot;_source&quot; : {
          &quot;url&quot; : &quot;/my_search_index/_search?q=elasticsearch&quot;
        },
        &quot;fields&quot; : {
          &quot;url.index&quot; : [
            &quot;my_search_index&quot;
          ]
        }
      }
    ]
  }
}
</code></pre><p>The important part is this one:</p><pre><code>&quot;fields&quot; : {
  &quot;url.index&quot; : [
    &quot;my_search_index&quot;
  ]
}
</code></pre><p>A neat thing about the <code>docvalue_fields</code> is that in the example above the <code>my_search_index</code> value is not comming from the <code>_source</code> of the document. This means that we can use <code>keywords</code> and by extension normalized <code>keywords</code> to fetch an exact value from the Elasticsearch index and not necessarily the one that was sent to Elasticsearch which somewhat solves our dependency from the upstream systems.</p><h2 id=notes>Notes</h2><p>The setup is done in the Kibana Dev Tools with the Elasticsearch 7.7.0.</p><p>The pattern <code>"/(.+)/.*"</code> is a bit simplified purely for presentation purposes and doesn&rsquo;t work as expected for URLs with more than 2 slashes, e.g.: <code>/index/type/_search</code> would produce <code>index/type</code>. You need something a bit more involved like <code>"/([^/]+)/.*"</code>.</p><h2 id=fin>Fin</h2><p>That is all I wanted to show you today. Hope it might be useful/interesting to someone down the line. Leave comments on the Github issue <a href=https://github.com/dainiusjocas/blog/issues/7>here</a>. Cheers!</p></div><div class=article-tags><a class="badge badge-light" href=/blog/tags/elasticsearch/>Elasticsearch</a></div><div class=share-box aria-hidden=true><ul class=share><li><a href="https://twitter.com/intent/tweet?url=https://www.jocas.lt/blog/post/elasticsearch-normlizers/&text=A%20Neat%20Trick%20with%20Elasticsearch%20Normalizers" target=_blank rel=noopener class=share-btn-twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=https://www.jocas.lt/blog/post/elasticsearch-normlizers/&t=A%20Neat%20Trick%20with%20Elasticsearch%20Normalizers" target=_blank rel=noopener class=share-btn-facebook><i class="fab fa-facebook-f"></i></a></li><li><a href="mailto:?subject=A%20Neat%20Trick%20with%20Elasticsearch%20Normalizers&body=https://www.jocas.lt/blog/post/elasticsearch-normlizers/" target=_blank rel=noopener class=share-btn-email><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=https://www.jocas.lt/blog/post/elasticsearch-normlizers/&title=A%20Neat%20Trick%20with%20Elasticsearch%20Normalizers" target=_blank rel=noopener class=share-btn-linkedin><i class="fab fa-linkedin-in"></i></a></li><li><a href="https://web.whatsapp.com/send?text=A%20Neat%20Trick%20with%20Elasticsearch%20Normalizers%20https://www.jocas.lt/blog/post/elasticsearch-normlizers/" target=_blank rel=noopener class=share-btn-whatsapp><i class="fab fa-whatsapp"></i></a></li></ul></div><div class="media author-card content-widget-hr"><div class=media-body><h5 class=card-title><a href=/blog/authors/dainius-jocas/></a></h5><ul class=network-icon aria-hidden=true></ul></div></div></div></article><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js integrity="sha256-1zu+3BnLYV9LdiY85uXMzii3bdrkelyp37e0ZyTAQh0=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/clojure.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/java.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin=anonymous></script><script>hljs.initHighlightingOnLoad();</script><script>const search_config={"indexURI":"/blog/index.json","minLength":1,"threshold":0.3};const i18n={"no_results":"No results found","placeholder":"Search...","results":"results found"};const content_type={'post':"Posts",'project':"Projects",'publication':"Publications",'talk':"Talks"};</script><script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script><script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script><script src=/blog/js/academic.min.d6bd04fdad2ad213aa8111c5a3b72fc5.js></script><div class=container><footer class=site-footer><p class=powered-by>© 2022 Dainius Jocas &#183;
Powered by the
<a href=https://sourcethemes.com/academic/ target=_blank rel=noopener>Academic theme</a> for
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a>.
<span class=float-right aria-hidden=true><a href=# class=back-to-top><span class=button_icon><i class="fas fa-chevron-up fa-2x"></i></span></a></span></p></footer></div><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i>Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i>Download</a><div id=modal-error></div></div></div></div></div></body></html>