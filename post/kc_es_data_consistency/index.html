<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academic 4.8.0"><meta name=description content="A shout-out about a lurking bug in the Kafka Connect Elasticsearch Sink connector"><link rel=alternate hreflang=en-us href=https://www.jocas.lt/blog/post/kc_es_data_consistency/><meta name=theme-color content="#2962ff"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark disabled><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin=anonymous async></script><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap"><link rel=stylesheet href=/blog/css/academic.css><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','UA-122337142-2');</script><link rel=manifest href=/blog/index.webmanifest><link rel=icon type=image/png href=/blog/images/icon_hu849715217c2cf577e44af3c34605d58b_27848_32x32_fill_lanczos_center_2.png><link rel=apple-touch-icon type=image/png href=/blog/images/icon_hu849715217c2cf577e44af3c34605d58b_27848_192x192_fill_lanczos_center_2.png><link rel=canonical href=https://www.jocas.lt/blog/post/kc_es_data_consistency/><meta property="twitter:card" content="summary_large_image"><meta property="og:site_name" content="Dainius Jocas"><meta property="og:url" content="https://www.jocas.lt/blog/post/kc_es_data_consistency/"><meta property="og:title" content="How to Prevent Data Corruption in Elasticsearch When Using Kafka Connect Elasticsearch Sink Connector | Dainius Jocas"><meta property="og:description" content="A shout-out about a lurking bug in the Kafka Connect Elasticsearch Sink connector"><meta property="og:image" content="https://www.jocas.lt/blog/post/kc_es_data_consistency/featured.png"><meta property="twitter:image" content="https://www.jocas.lt/blog/post/kc_es_data_consistency/featured.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2020-10-03T00:00:00+00:00"><meta property="article:modified_time" content="2020-10-03T00:00:00+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.jocas.lt/blog/post/kc_es_data_consistency/"},"headline":"How to Prevent Data Corruption in Elasticsearch When Using Kafka Connect Elasticsearch Sink Connector","image":["https://www.jocas.lt/blog/post/kc_es_data_consistency/featured.png"],"datePublished":"2020-10-03T00:00:00Z","dateModified":"2020-10-03T00:00:00Z","author":{"@type":"Person","name":"Dainius Jocas"},"publisher":{"@type":"Organization","name":"Dainius Jocas","logo":{"@type":"ImageObject","url":"https://www.jocas.lt/blog/images/icon_hu849715217c2cf577e44af3c34605d58b_27848_192x192_fill_lanczos_center_2.png"}},"description":"A shout-out about a lurking bug in the Kafka Connect Elasticsearch Sink connector"}</script><title>How to Prevent Data Corruption in Elasticsearch When Using Kafka Connect Elasticsearch Sink Connector | Dainius Jocas</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search class=form-control></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/blog/>Dainius Jocas</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/blog/>Dainius Jocas</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/blog/#posts><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/blog/#projects><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/blog/#talks><span>Talks</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a></li><li class="nav-item dropdown theme-dropdown"><a href=# class="nav-link js-theme-selector" data-toggle=dropdown aria-haspopup=true><i class="fas fa-palette" aria-hidden=true></i></a><div class=dropdown-menu><a href=# class="dropdown-item js-set-theme-light"><span>Light</span></a>
<a href=# class="dropdown-item js-set-theme-dark"><span>Dark</span></a>
<a href=# class="dropdown-item js-set-theme-auto"><span>Automatic</span></a></div></li></ul></div></nav><article class=article><div class="article-container pt-3"><h1>How to Prevent Data Corruption in Elasticsearch When Using Kafka Connect Elasticsearch Sink Connector</h1><div class=article-metadata><div><span>Dainius Jocas</span></div><span class=article-date>Oct 3, 2020</span>
<span class=middot-divider></span><span class=article-reading-time>5 min read</span>
<span class=middot-divider></span><span class=article-categories><i class="fas fa-folder mr-1"></i><a href=/blog/categories/elasticsearch/>Elasticsearch</a>, <a href=/blog/categories/kafka-connect/>Kafka Connect</a></span></div><div class="btn-links mb-3"></div></div><div class="article-header article-container featured-image-wrapper mt-4 mb-4" style=max-width:720px;max-height:192px><div style=position:relative><img src=/blog/post/kc_es_data_consistency/featured_hu2e60df7deec0e7ec3759fe2778f63032_20765_720x0_resize_lanczos_2.png alt class=featured-image>
<span class=article-header-caption>Kafka Connect Elasticsearch Sink</span></div></div><div class=article-container><div class=article-style><h3 id=tldr>TL;DR</h3><p>When the
<a href=https://github.com/confluentinc/kafka-connect-elasticsearch target=_blank rel=noopener>Elasticsearch indexer</a> is highly concurrent, Kafka record keys are used as Elasticsearch document IDs, and indexer is set to delete records on <code>null</code> values, then Kafka Connect Elasticsearch Sink Connector might corrupt your data: documents that should not be deleted end up being deleted, or documents that should be deleted end up still being present in the index. The fix is to use external versioning for deletes in bulk requests as it is proposed in this
<a href=https://github.com/confluentinc/kafka-connect-elasticsearch/pull/422 target=_blank rel=noopener>Github Pull Request</a>.</p><h3 id=the-problem>The problem</h3><p>NOTE: as of version 6.0.0 of the Confluent Platform (last checked on 2020-10-02) the bug that might lead to data corruption is still present.</p><p>Let&rsquo;s focus on a use case where Kafka record key is used as an Elasticsearch document ID<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. I would consider this to be a proper practice when the documents represent a catalog of things.</p><p>Elasticsearch uses
<a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/optimistic-concurrency-control.html target=_blank rel=noopener>optimistic concurrency control</a>. The job of this concurrency mechanism is to ensure that older version of the document doesn&rsquo;t override a newer version. By default, order of arrival of the operation is applied, but the behaviour can be overriden in
<a href=https://www.elastic.co/blog/elasticsearch-versioning-support target=_blank rel=noopener>several ways</a> depending on the version of Elasticsearch. In this post we focus on concurrent bulk requests, and with a concurrency that involves a network, requests will sometimes arrive out of order.</p><p>To help Elasticsearch resolve the out-of-order indexing requests Kafka Connect Elasticsearch Sink Connector (from here on Kafka Connect for short) leverages the
<a href=https://github.com/confluentinc/kafka-connect-elasticsearch/blob/7256e9473cea690c373058b88fffd1111870cfe6/src/main/java/io/confluent/connect/elasticsearch/jest/JestElasticsearchClient.java#L564 target=_blank rel=noopener><code>external</code> document</a> versioning<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. Using external versions in Kafka Connect makes sense because we already have versioning in place: Kafka topic partition offsets. If Kafka Connect applies changes to Elasticsearch indices in order of the topic offset, then any update ordering problems would be problems in the upstream system. This is a good guarantee to have.</p><p>Let&rsquo;s add to the mix delete operations. Kafka Connect supports a setting <code>BEHAVIOR_ON_NULL_VALUES_CONFIG</code> to <code>"delete"</code>. This setting instructs the Kafka Connect that a document in Elasticsearch with an ID of the kafka record key with <code>null</code> value (a tombstone message) is going to be deleted. But for some strange reason the deletes <strong>does not use external versioning</strong>! The line responsible for the described behaviour<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> can be found
<a href=https://github.com/confluentinc/kafka-connect-elasticsearch/blob/7256e9473cea690c373058b88fffd1111870cfe6/src/main/java/io/confluent/connect/elasticsearch/jest/JestElasticsearchClient.java#L554 target=_blank rel=noopener>here</a>. This means that for deletes the order-of-arrival wins. Let&rsquo;s increase the concurrency of bulk requests with the param <code>MAX_IN_FLIGHT_REQUESTS_CONFIG</code> to a largish number, and the data consistency problems is just round the corner for data that has some largish update ratio.</p><p>The issue is even more pronounced when you re-index data into Elasticsearch and you want to do it as fast as possible, which means doing the indexing concurrently.</p><h3 id=the-example>The Example</h3><p>The code that demonstrated the faulty behaviour can be found in this
<a href=https://github.com/confluentinc/kafka-connect-elasticsearch/pull/422 target=_blank rel=noopener>Pull Request</a>.</p><p>The test case is for testing the case when document should be present in Elasticsearch gets deleted.</p><p>Let&rsquo;s have a little walk over the code snippet:</p><pre><code class=language-java>Collection&lt;SinkRecord&gt; records = new ArrayList&lt;&gt;();
for (int i = 0; i &lt; numOfRecords - 1 ; i++) {
  if (i % 2 == 0) {
    SinkRecord sinkRecord = new SinkRecord(TOPIC, PARTITION, Schema.STRING_SCHEMA, key, schema, null, i);
    records.add(sinkRecord);
  } else {
    record.put(&quot;message&quot;, Integer.toString(i));
    SinkRecord sinkRecord = new SinkRecord(TOPIC, PARTITION, Schema.STRING_SCHEMA, key, schema, record, i);
    records.add(sinkRecord);
  }
}
record.put(&quot;message&quot;, Integer.toString(numOfRecords));
SinkRecord sinkRecord = new SinkRecord(TOPIC, PARTITION, Schema.STRING_SCHEMA, key, schema, record, numOfRecords);
records.add(sinkRecord);

task.put(records);
task.flush(null);
</code></pre><p>Here we send <code>numOfRecords</code> (which larger than 2) to a Kafka topic. Every second record has <code>null</code> body (delete operation), and the rest of the records have a sequence number as a <code>message</code> value. The very last record is <strong>always</strong> a non-null record with a <code>message</code> value of <code>numOfRecords</code>.</p><p>Let&rsquo;s setup a connector:</p><pre><code class=language-java>KEY_IGNORE_CONFIG = &quot;false&quot;;
MAX_IN_FLIGHT_REQUESTS_CONFIG = Integer.toString(numOfRecords)
BATCH_SIZE_CONFIG = &quot;1&quot;
LINGER_MS_CONFIG = &quot;1&quot;
BEHAVIOR_ON_NULL_VALUES_CONFIG = &quot;delete&quot;
</code></pre><p>Here we set a connector to use Kafka record key as id <code>KEY_IGNORE_CONFIG = "false"</code>, set the indexer concurrency to the <code>numOfRecords</code>; set the indexing batch size to 1 (this creates as many requests to Elasticsearch as there are records in the Kafka topic); set indexer to send requests immediately with <code>LINGER_MS_CONFIG = "1"</code>; and record with a <code>null</code> value represents a delete operation.</p><p>With this setup after the indexing is done we expect that in the index we have a document with ID and whose <code>message</code> value is <code>numOfRecords</code>. But when ordering of bulk requests is out-of-order then at the end we might have a situation where there is no document in the index at all: the bulk index request with <code>message = numOfRecords</code> arrived before one of the bulk requests with a delete operation!</p><p>The situation might seem to be a bit far-fetched but for applications like e-commerce where you have a catalog that is frequently updated (e.g. the catalog item should be available in search or not) and updates are modelled as document deletes it happens a bit more often than it might be expected.</p><h3 id=the-fix>The fix</h3><p>The fix is simple: use the same external versioning that is already being used by the indexing requests also for delete requests:</p><pre><code class=language-java>if (record.version != null) {
    req.setParameter(&quot;version_type&quot;, &quot;external&quot;).setParameter(&quot;version&quot;, record.version);
}
</code></pre><p>The full code can be found
<a href=ttps://github.com/confluentinc/kafka-connect-elasticsearch/pull/422>here</a>. Let&rsquo;s hope that Confluent developers will find some time to merge that PR.</p><h3 id=conclusion>Conclusion</h3><p>Thank you for reading and leave your feedback
<a href=https://github.com/dainiusjocas/blog/issues/12 target=_blank rel=noopener>here</a>.</p><h3 id=ps>P.S.</h3><p>Of course, this is not the only situation when data can get
<a href=https://github.com/confluentinc/kafka-connect-elasticsearch/issues target=_blank rel=noopener>corrupted</a>, e.g. changing the number of partitions; when you delete the topic, repopulate it with up-to-date data (also, you skip deletes) then restarting the indexing might pretty much nothing, because all the versions are earlier <code>external version</code> because offsets are smaller.</p><h3 id=heading></h3><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>When Kafka Record keys are not used as Elasticsearch document IDs versioning is not a problem because every Elasticsearch ID is constructed as <code>{topic}+{partition}+{offset}</code> which creates a new document for every Kafka record, i.e. no versioning is needed. <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>Elasticsearch 7 supports the
<a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/breaking-changes-7.0.html#_internal_versioning_is_no_longer_supported_for_optimistic_concurrency_control target=_blank rel=noopener>external versioning</a>. <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p>Yes, it is a comment, and it means that the developers were not sure whether to use external versioning for delete operations. <a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div><div class=article-tags><a class="badge badge-light" href=/blog/tags/elasticsearch/>Elasticsearch</a>
<a class="badge badge-light" href=/blog/tags/kafka-connect/>Kafka Connect</a></div><div class=share-box aria-hidden=true><ul class=share><li><a href="https://twitter.com/intent/tweet?url=https://www.jocas.lt/blog/post/kc_es_data_consistency/&text=How%20to%20Prevent%20Data%20Corruption%20in%20Elasticsearch%20When%20Using%20Kafka%20Connect%20Elasticsearch%20Sink%20Connector" target=_blank rel=noopener class=share-btn-twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=https://www.jocas.lt/blog/post/kc_es_data_consistency/&t=How%20to%20Prevent%20Data%20Corruption%20in%20Elasticsearch%20When%20Using%20Kafka%20Connect%20Elasticsearch%20Sink%20Connector" target=_blank rel=noopener class=share-btn-facebook><i class="fab fa-facebook-f"></i></a></li><li><a href="mailto:?subject=How%20to%20Prevent%20Data%20Corruption%20in%20Elasticsearch%20When%20Using%20Kafka%20Connect%20Elasticsearch%20Sink%20Connector&body=https://www.jocas.lt/blog/post/kc_es_data_consistency/" target=_blank rel=noopener class=share-btn-email><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=https://www.jocas.lt/blog/post/kc_es_data_consistency/&title=How%20to%20Prevent%20Data%20Corruption%20in%20Elasticsearch%20When%20Using%20Kafka%20Connect%20Elasticsearch%20Sink%20Connector" target=_blank rel=noopener class=share-btn-linkedin><i class="fab fa-linkedin-in"></i></a></li><li><a href="https://web.whatsapp.com/send?text=How%20to%20Prevent%20Data%20Corruption%20in%20Elasticsearch%20When%20Using%20Kafka%20Connect%20Elasticsearch%20Sink%20Connector%20https://www.jocas.lt/blog/post/kc_es_data_consistency/" target=_blank rel=noopener class=share-btn-whatsapp><i class="fab fa-whatsapp"></i></a></li></ul></div></div></article><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin=anonymous></script><script>const code_highlighting=true;</script><script>const isSiteThemeDark=false;</script><script>const search_config={"indexURI":"/blog/index.json","minLength":1,"threshold":0.3};const i18n={"no_results":"No results found","placeholder":"Search...","results":"results found"};const content_type={'post':"Posts",'project':"Projects",'publication':"Publications",'talk':"Talks",'slides':"Slides"};</script><script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script><script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script><script src=/blog/js/academic.min.66c553246b0f279a03be6e5597f72b52.js></script><div class=container><footer class=site-footer><p class=powered-by>Â© 2020 Dainius Jocas</p><p class=powered-by>Published with
<a href=https://sourcethemes.com/academic/ target=_blank rel=noopener>Academic Website Builder</a>
<span class=float-right aria-hidden=true><a href=# class=back-to-top><span class=button_icon><i class="fas fa-chevron-up fa-2x"></i></span></a></span></p></footer></div><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i>Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i>Download</a><div id=modal-error></div></div></div></div></div></body></html>